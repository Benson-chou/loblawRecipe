<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <title>Login</title>
    <!-- the form awesome library is used to add icons to our form -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- include the stylesheet file -->
    <link href="/user.css" rel="stylesheet" type="text/css">
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
        }
    </style>
    <script>
        function checkNames() {
            // validation image div
            var validationElement = document.getElementById('nameValidation');
            // Get form values
            var newPass1 = document.getElementById('newPassword').value;
            var newPass2 = document.getElementById('twonewPassword').value;
            console.log(newPass1)
            console.log(newPass2)
            console.log(newPass1 === newPass2)
            // Reset validation element styles
            validationElement.style.display = 'none';
            validationElement.className = 'validation-image';
            // check if newPass2 exists
            if (newPass2) {
                console.log("hi")
                validationElement.style.display = 'inline-block';
                // Choose which class to add to the element
                validationElement.className += 
                    (newPass1 == newPass2 ? ' validation-success' : ' validation-error');
                if (newPass1 && newPass2 && newPass1 === newPass2) {
                    enableSubmitButton();
                    console.log('New password matches. Submit button enabled');
                    return;
                } else {
                    alert("New passwords don't match. Please re-enter");
                    return;
                }
            }
        }
        function enableSubmitButton(){
             var submitButton = document.getElementById('passwordUpdate-btn');
             console.log(submitButton.attributes)
            submitButton.removeAttribute('disabled');
        }
        function savebutton(recipe_name, recipe_ingredients, recipe_description, loggedin, username) {
            var save_button = document.querySelector('.save_button');
            var icon = save_button.querySelector('i');
            // This works but not sure y regular and solid looks the same :(
            if (!loggedin) {
                alert('Please Log in/Sign up to save ')
                return;
            }
            if (icon.classList.contains("fa-regular")) {
                icon.classList.remove("fa-regular", "fa-bookmark")
                icon.classList.add("fa-solid", "fa-flag")
                // Save the recipe here by sending POST request
                fetch('/home/save', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    }, 
                    body: JSON.stringify({
                        recipe_name: recipe_name, 
                        recipe_ingredients: recipe_ingredients, 
                        recipe_description: recipe_description, 
                        username: username
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Recipe saved: ', data);
                })
                .catch((error) => {
                    console.log('Error saving recipe: ', error);
                    // Revert icon if error
                    icon.classList.remove("fa-solid", "fa-flag")
                    icon.classList.add("fa-regular", "fa-bookmark")
                });                
            } else {
                icon.classList.remove("fa-solid", "fa-flag")
                icon.classList.add("fa-regular", "fa-bookmark")
                // Delete the recipe by sending POST request
                fetch('/home/delete', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    }, 
                    body: JSON.stringify({
                        recipe_name: recipe_name, 
                        username: username
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Recipe deleted:', data);
                })
                .catch((error) => {
                    console.error('Error deleting recipe:', error);
                    // Revert icon if error
                    icon.classList.remove("fa-regular", "fa-bookmark")
                    icon.classList.add("fa-solid", "fa-flag")
                });
            }
        }

    </script>
</head>

<body>
    <div class="header-container">
        <div class="header">
            <div class="logo">Loblaws Recipe</div>
            <ul class="links">
                <li><%= username %></li>
                <li><a href="../home/">Home</a></li>
                <% if (!loggedin) { %> 
                    <li><a href="../login/">Log In</a></li>
                <% } %>
                <li><a href="../login/">Log out</a></li>
                <li>
                    <div class="github">
                        <a href="https://github.com/Benson-chou/loblawRecipe" target="_blank">
                            <img class="cat-logo" src="/github-mark-white.png" alt="GitHub Cat Logo">
                            <img class="text-logo" src="/GitHub_Logo_White.png" alt="GitHub Text Logo">
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="content-container">
        <div class = "inputs">
            <form id="locationForm" action="/user/location" method="post">
                <% if (location) {%>
                    <label for="location">Location: </label>
                    <input type="text" name="location" placeholder="<%=location%>" id="location" 
                    pattern="^[A-CEGHJ-NPRSTVXYa-ceghj-nprstvxy]\d[A-CEGHJ-NPRSTV-Za-ceghj-nprstv-z]\s*\d[A-CEGHJ-NPRSTV-Za-ceghj-nprstv-z]\d$" required>
                <% } else { %>
                    <label for="location">Location: </label>
                    <input type="text" name="location" placeholder="m5b1r7" id="location" 
                    pattern="^[A-CEGHJ-NPRSTVXYa-ceghj-nprstvxy]\d[A-CEGHJ-NPRSTV-Za-ceghj-nprstv-z]\s*\d[A-CEGHJ-NPRSTV-Za-ceghj-nprstv-z]\d$" required>
                <% } %>
                <input type="submit" name="locationChange" value="Update">
            </form>
            <form id="allergiesForm" action="/user/allergies" method="post">
                <% if (allergies) {%>
                    <label for="allergies">Allergies: </label>
                    <input type="text" name="allergies" placeholder="<%=allergies%>" id="allergies">
                <% } else { %>
                    <label for="allergies">Allergies: </label>
                    <input type="text" name="allergies" placeholder="None" id="allergies">
                <% } %>
                <input type="submit" name="allergiesChange" value="Update">
            </form>
            <% if (loggedin){%>
                <form name="changePassword" action="/user/changePassword" method="post">
                    <label for="oldPassword">Old Password: </label>
                    <input type="password" id="oldPassword" name="oldPassword" required>
                    <!-- Need function to check that new and re-enter are the same -->
                     <!-- https://stackoverflow.com/questions/21648374/check-if-two-fields-has-the-same-value-with-javascript -->
                    <label for="newPassword">New Password: </label>
                    <input type="password" id="newPassword" name="newPassword" required>
                    <label for="twonewPassword">Re-enter New Password: </label>
                    <input type="password" id="twonewPassword" name="twonewPassword" onblur="checkNames()" required>
                    <div id="nameValidation" class="validation-image"></div>
                    <input type="submit" id="passwordUpdate-btn" value="Update" disabled>
                </form> 
            <% } %>
        </div>
        <% if (updateFail.length > 0) { %>
            <div class="alert-fail">
                <%= updateFail %>
            </div>
        <% } %>
        <% if (updateSuccess.length > 0) { %>
            <div class="alert-success">
                <%= updateSuccess %>
            </div>
        <% } %>
        <% if (loggedin){%>
        <section id="SavedRecipes">
            <div class="table">
                <table id="headers">
                    <thead>
                        <th id="recipename">Recipe Name</th>
                        <th id="ingredients">Ingredients</th>
                        <th id="instuctions">Instructions</th>
                        <th id="save">Save</th>
                    </thead>
                    <tbody>
                        <% if(recipes) {%>
                            <% recipes.forEach(recipe=> { %>
                                <tr>
                                    <td><%= recipe.Recipe_name %></td>
                                    <td><%= recipe.Ingredients %></td>
                                    <td><%= recipe.Instructions %></td>
                                    <td><button type="button" class="save_button" onclick="savebutton('<%= recipe.Recipe_name%>', `<%= recipe.Ingredients%>`, `<%= recipe.Instructions%>`, '<%= loggedin%>', '<%= username%>')" 
                                        value="<%= recipe.id%>">
                                        <i class="fa fa-solid fa-flag"></i>
                                    </button></td>
                                    <!-- Before saved: <i class="fa fa-regular fa-bookmark"></i> -->
                                     <!-- After saved: <i class="fa fa-solid fa-bookmark"></i> -->
                                </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>
        <% } %>
    </div>
</body>